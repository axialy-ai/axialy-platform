---
# Role: docker  (single-host “poor-man’s” deployment)

- name: Ensure base directory exists
  file:
    path: /opt/axialy
    state: directory
    mode: "0755"

- name: Render .env for containers
  copy:
    dest: /opt/axialy/.env
    mode: "0600"
    owner: root
    group: root
    content: |
      # Auto-generated by Ansible – {{ ansible_date_time.iso8601 }}

      # ── Application ───────────────────────────────────────────────
      ADMIN_DEFAULT_USER={{ lookup('env','ADMIN_DEFAULT_USER') }}
      ADMIN_DEFAULT_PASSWORD={{ lookup('env','ADMIN_DEFAULT_PASSWORD') }}
      ADMIN_DEFAULT_EMAIL={{ lookup('env','ADMIN_DEFAULT_EMAIL') }}

      # ── Admin DB (Axialy_ADMIN) ───────────────────────────────────
      DB_HOST={{ lookup('env','DB_HOST') }}
      DB_PORT={{ lookup('env','DB_PORT') }}
      DB_NAME=Axialy_ADMIN
      DB_USER={{ lookup('env','DB_USERNAME') }}
      DB_PASSWORD={{ lookup('env','DB_PASSWORD') }}

      # ── UI DB (Axialy_UI) ─────────────────────────────────────────
      UI_DB_HOST={{ lookup('env','DB_HOST') }}
      UI_DB_PORT={{ lookup('env','DB_PORT') }}
      UI_DB_NAME=Axialy_UI
      UI_DB_USER={{ lookup('env','DB_USERNAME') }}
      UI_DB_PASSWORD={{ lookup('env','DB_PASSWORD') }}

- name: Deploy / update the stack
  community.docker.docker_compose_v2:
    project_name: axialy-admin
    definition: "{{ lookup('file', playbook_dir + '/../../../../docker/compose.yml') }}"
    state: present
