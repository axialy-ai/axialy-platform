#cloud-config
###############################################################################
#  Axialy – admin droplet bootstrap
###############################################################################

package_update: true
package_upgrade: true

packages:
  # Web stack
  - nginx
  - php8.1-fpm          # PHP FastCGI daemon
  - php8.1-cli
  - php8.1-mysql        # PDO / MySQLi
  # Convenience
  - unzip
  - git

write_files:
  ###########################################################################
  #  Nginx vhost ( /etc/nginx/sites-available/default )
  ###########################################################################
  - path: /etc/nginx/sites-available/default
    owner: root:root
    permissions: "0644"
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;

          server_name admin.axialy.ai _;

          root /var/www/html;
          index index.php index.html;

          # Pretty URLs -----------------------------------------------------
          location / {
              try_files $uri $uri/ /index.php?$args;
          }

          # PHP -------------------------------------------------------------
          location ~ \.php$ {
              include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/run/php/php8.1-fpm.sock;
          }

          # Static assets – cache forever -----------------------------------
          location ~* \.(?:js|css|png|jpe?g|gif|ico|svg)$ {
              try_files $uri =404;
              expires max;
              access_log off;
              log_not_found off;
          }

          # Block hidden files (.env, .git …) -------------------------------
          location ~ /\.(?!well-known).* {
              deny all;
          }

          access_log  /var/log/nginx/access.log;
          error_log   /var/log/nginx/error.log warn;
      }

runcmd:
  # Ensure PHP-FPM is enabled + running (creates /run/php/php8.1-fpm.sock)
  - systemctl enable --now php8.1-fpm
  # Reload nginx after the vhost + socket exist
  - systemctl reload nginx
