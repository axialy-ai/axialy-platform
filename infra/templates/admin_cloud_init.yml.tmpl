#cloud-config
###############################################################################
# Axialy – Admin droplet bootstrap
# Rendered by Terraform.
###############################################################################

###############################################################################
# 1  Packages
###############################################################################
package_update: true
package_upgrade: true
packages:
  - nginx
  - php8.1-fpm
  - php8.1-cli
  - php8.1-mysql
  - php8.1-curl
  - php8.1-xml
  - php8.1-mbstring
  - unzip
  - git

###############################################################################
# 2  DB credentials → .env  (read by PHP *and* fallback for AdminDBConfig)
###############################################################################
write_files:
  - path: /var/www/html/.env
    owner: www-data:www-data
    permissions: "0600"
    content: |
      DB_HOST=${db_host}
      DB_PORT=3306
      DB_NAME=${db_name}
      DB_USER=${db_user}
      DB_PASSWORD=${db_pass}

###############################################################################
# 3  Nginx virtual host  – doc-root **/var/www/html**
###############################################################################
  - path: /etc/nginx/sites-available/admin.axialy.ai
    owner: root:root
    permissions: "0644"
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;

          server_name admin.axialy.ai _;
          root /var/www/html;
          index index.php index.html;

          # pretty URLs
          location / {
              try_files $uri $uri/ /index.php?$args;
          }

          # PHP
          location ~ \.php$ {
              include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/run/php/php8.1-fpm.sock;
          }

          # Static assets – cache forever
          location ~* \.(?:js|css|png|jpe?g|gif|ico|svg|woff2?)$ {
              expires max;
              access_log off;
              log_not_found off;
          }

          # Block hidden files (.env, .git, …)
          location ~ /\.(?!well-known) {
              deny all;
          }
      }

###############################################################################
# 4  Pass the same DB vars into PHP-FPM workers
###############################################################################
  - path: /etc/php/8.1/fpm/pool.d/99-axialy-env.conf
    owner: root:root
    permissions: "0644"
    content: |
      ; auto-generated by cloud-config
      env[DB_HOST]     = ${db_host}
      env[DB_PORT]     = 3306
      env[DB_NAME]     = ${db_name}
      env[DB_USER]     = ${db_user}
      env[DB_PASSWORD] = ${db_pass}

###############################################################################
# 5  Initialisation commands
###############################################################################
runcmd:
  # Enable our site, disable the default
  - [ bash, -c, "ln -sf /etc/nginx/sites-available/admin.axialy.ai /etc/nginx/sites-enabled/admin.axialy.ai" ]
  - [ bash, -c, "rm -f /etc/nginx/sites-enabled/default" ]

  # Correct permissions for web-root
  - [ bash, -c, "chown -R www-data:www-data /var/www/html" ]

  # Kick services
  - [ systemctl, enable, --now, php8.1-fpm ]
  - [ systemctl, enable, --now, nginx ]
  - [ systemctl, reload, nginx ]
