name: Terraform DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      TF_VAR_do_token:    ${{ secrets.DIGITALOCEAN_TOKEN }}
      NAMESILO_API_KEY:   ${{ secrets.NAMESILO_API_KEY }}
      NAMESILO_DOMAIN:    axialy.ai
      DROPLET_SSH_KEY:    ${{ secrets.DROPLET_SSH_KEY }}

    steps:
    - uses: actions/checkout@v4

    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.8.2

    - name: Install doctl
      run: |
        VER=$(curl -s https://api.github.com/repos/digitalocean/doctl/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -sL "https://github.com/digitalocean/doctl/releases/download/v${VER}/doctl-${VER}-linux-amd64.tar.gz" | tar -xz
        sudo mv doctl /usr/local/bin

    - name: Authenticate doctl
      run: doctl auth init -t "$DIGITALOCEAN_TOKEN"

    - name: Terraform Init
      run: terraform -chdir=infra init -upgrade

    - name: Identify missing droplets & delete DNS A records
      env:
        KEY: ${{ secrets.NAMESILO_API_KEY }}
        DOMAIN: axialy.ai
      run: |
        chmod +x infra/delete_dns_records.sh
        ./infra/delete_dns_records.sh

    - name: Terraform Plan
      run: terraform -chdir=infra plan -input=false

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      run: terraform -chdir=infra apply -auto-approve -input=false

    - name: Terraform Outputs
      id: ips
      run: |
        IPS=$(terraform -chdir=infra output -json droplet_ips)
        echo "ROOT_IP=$(  echo "$IPS" | jq -r '.root')"  >> "$GITHUB_ENV"
        echo "UI_IP=$(    echo "$IPS" | jq -r '.ui')"    >> "$GITHUB_ENV"
        echo "API_IP=$(   echo "$IPS" | jq -r '.api')"   >> "$GITHUB_ENV"
        echo "ADMIN_IP=$( echo "$IPS" | jq -r '.admin')" >> "$GITHUB_ENV"

    - name: Update NameSilo DNS Records
      if: github.ref == 'refs/heads/main'
      run: |
        chmod +x infra/update_namesilo.sh
        ./infra/update_namesilo.sh
