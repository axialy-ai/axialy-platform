name: Terraform DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  terraform:
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Jobâ€‘wide environment  â€“ ALL secrets UPPERâ€‘CASE
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    env:
      # DigitalOcean
      DIGITALOCEAN_TOKEN:      ${{ secrets.DIGITALOCEAN_TOKEN }}
      TF_VAR_do_token:         ${{ secrets.TF_VAR_DO_TOKEN }}

      # NameSilo
      NAMESILO_API_KEY:        ${{ secrets.NAMESILO_API_KEY }}
      NAMESILO_DOMAIN:         axialy.ai          # literal

      # SSH key material
      DROPLET_SSH_KEY:         ${{ secrets.DROPLET_SSH_KEY }}
      DROPLET_SSH_PASSPHRASE:  ${{ secrets.DROPLET_SSH_PASSPHRASE }}

      # fingerprint injected into every droplet via TF
      TF_VAR_ssh_fingerprint:  ${{ secrets.SSH_FINGERPRINT }}

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1 â€” Checkout repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2 â€” Remove stale TF artefacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Remove stale Terraform artefacts
      run: |
        rm -f infra/terraform.tfstate*
        rm -f infra/.terraform.lock.hcl
        rm -rf infra/.terraform

    # â”€â”€â”€ 3 â€” Detect content changes (marketing / ui / admin / api) â”€â”€
    - id: filter
      uses: dorny/paths-filter@v3
      with:
        list-files: none
        initial-fetch-depth: 100
        filters: |
          marketing:
            - 'axialy-marketing-site/**'
          ui:
            - 'axialy-ui-product/**'
          admin:
            - 'axialy-admin-product/**'
          api:
            - 'axialy-api-product/**'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4 â€” Install doctl & authenticate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install doctl
      run: |
        set -e
        VER=$(curl -s https://api.github.com/repos/digitalocean/doctl/releases/latest \
               | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -sL "https://github.com/digitalocean/doctl/releases/download/v${VER}/doctl-${VER}-linux-amd64.tar.gz" \
          | tar -xz
        sudo mv doctl /usr/local/bin

    - name: doctl auth
      run: doctl auth init -t "$DIGITALOCEAN_TOKEN"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5 â€” Install Terraform CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.8.2

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6 â€” Terraform init / import / plan / apply â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform init
      run: terraform -chdir=infra init

    - name: Import existing resources
      run: bash infra/import_existing.sh

    - name: Purge stale NameSilo Aâ€‘records
      env:
        NAMESILO_API_KEY: ${{ env.NAMESILO_API_KEY }}
        NAMESILO_DOMAIN:  ${{ env.NAMESILO_DOMAIN }}
      run: bash infra/purge_namesilo_missing.sh

    - name: Terraform plan
      run: terraform -chdir=infra plan -input=false

    - name: Terraform apply
      if: github.ref == 'refs/heads/main'
      run: terraform -chdir=infra apply -auto-approve -input=false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7 â€” Capture droplet IPs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - id: ips
      run: |
        IPS=$(terraform -chdir=infra output -json droplet_ips)
        echo "ROOT_IP=$(  echo "$IPS" | jq -r '.root')"  >> "$GITHUB_ENV"
        echo "UI_IP=$(    echo "$IPS" | jq -r '.ui')"    >> "$GITHUB_ENV"
        echo "API_IP=$(   echo "$IPS" | jq -r '.api')"   >> "$GITHUB_ENV"
        echo "ADMIN_IP=$( echo "$IPS" | jq -r '.admin')" >> "$GITHUB_ENV"

    # â”€â”€â”€â”€â”€ 8 â€” Wait for SSH on all four droplets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â³ Wait for SSH on droplets
      shell: bash
      run: |
        wait_ssh () {
          local host=$1
          echo "ğŸ“¡  Waiting for $host â€¦"
          for i in {1..30}; do
            nc -z -w3 "$host" 22 && { echo "âœ…  $host reachable"; return; }
            sleep 5
          done
          echo "::error::$host never became reachable"; exit 1
        }
        wait_ssh "$ROOT_IP"
        wait_ssh "$UI_IP"
        wait_ssh "$ADMIN_IP"
        wait_ssh "$API_IP"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9 â€” Update NameSilo DNS records â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Update NameSilo DNS
      if: github.ref == 'refs/heads/main'
      env:
        NAMESILO_API_KEY: ${{ env.NAMESILO_API_KEY }}
        NAMESILO_DOMAIN:  ${{ env.NAMESILO_DOMAIN }}
      run: bash infra/update_namesilo.sh

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10 â€” Provision Admin droplet (PHPâ€‘FPM + vhost) â”€â”€
    - name: Provision Admin droplet
      uses: appleboy/ssh-action@v0.1.6
      with:
        host:       ${{ env.ADMIN_IP }}
        username:   root
        key:        ${{ env.DROPLET_SSH_KEY }}
        passphrase: ${{ env.DROPLET_SSH_PASSPHRASE }}
        script: |
          set -e
          export DEBIAN_FRONTEND=noninteractive
          if ! command -v nginx >/dev/null 2>&1; then
            apt-get update -y
            apt-get install -y nginx php-fpm php-mysql
          fi
          PHP_SOCK=$(ls /run/php/php*-fpm.sock | head -n1)
          cat >/etc/nginx/sites-available/default <<EOF
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              server_name admin.axialy.ai;

              root /var/www/html;
              index index.php index.html;

              location / {
                  try_files $uri $uri/ /index.php?$args;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:${PHP_SOCK};
              }
          }
          EOF
          systemctl enable --now nginx
          systemctl restart nginx
          systemctl restart php*-fpm

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 11 â€” Copy builds to droplets via rsync (scp) â”€â”€â”€â”€â”€

    - name: Deploy marketing site â†’ root droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:       ${{ env.ROOT_IP }}
        username:   root
        key:        ${{ env.DROPLET_SSH_KEY }}
        passphrase: ${{ env.DROPLET_SSH_PASSPHRASE }}
        source:     axialy-marketing-site/*
        target:     /var/www/html/
        strip_components: 1
        timeout:    120s

    - name: Deploy UI product â†’ ui droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:       ${{ env.UI_IP }}
        username:   root
        key:        ${{ env.DROPLET_SSH_KEY }}
        passphrase: ${{ env.DROPLET_SSH_PASSPHRASE }}
        source:     axialy-ui-product/*
        target:     /var/www/html/
        strip_components: 1
        timeout:    120s

    - name: Deploy Admin product â†’ admin droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:       ${{ env.ADMIN_IP }}
        username:   root
        key:        ${{ env.DROPLET_SSH_KEY }}
        passphrase: ${{ env.DROPLET_SSH_PASSPHRASE }}
        source:     axialy-admin-product/*
        target:     /var/www/html/
        strip_components: 1
        timeout:    120s

    - name: Deploy API product â†’ api droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:       ${{ env.API_IP }}
        username:   root
        key:        ${{ env.DROPLET_SSH_KEY }}
        passphrase: ${{ env.DROPLET_SSH_PASSPHRASE }}
        source:     axialy-api-product/*
        target:     /var/www/html/
        strip_components: 1
        timeout:    120s
