name: DigitalOcean Infrastructure + Marketing Site

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  DIGITALOCEAN_TOKEN:  ${{ secrets.DO_TOKEN }}
  TF_VAR_do_token:      ${{ secrets.DO_TOKEN }}

  NAMESILO_API_KEY:     ${{ secrets.NAMESILO_API_KEY }}
  NAMESILO_DOMAIN:      axialy.ai

jobs:
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1)  Detect what changed
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  filter:
    runs-on: ubuntu-latest
    outputs:
      site_changed: ${{ steps.paths.outputs.marketing }}

    steps:
      - name: ğŸ›ï¸  Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: paths
        name: ğŸ“‚ Detect changes under axialy-marketing-site/
        uses: dorny/paths-filter@v3
        with:
          filters: |
            marketing:
              - 'axialy-marketing-site/**'
          token: ${{ secrets.GITHUB_TOKEN }}
          list-files: none
          initial-fetch-depth: 100

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2)  Terraform + DNS
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  terraform:
    needs: filter
    runs-on: ubuntu-latest
    outputs:
      root_ip:  ${{ steps.ip.outputs.root }}
      ui_ip:    ${{ steps.ip.outputs.ui }}
      api_ip:   ${{ steps.ip.outputs.api }}
      admin_ip: ${{ steps.ip.outputs.admin }}

    steps:
      - name: ğŸ›ï¸  Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ doctl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install doctl
        run: |
          set -e
          VER=$(curl -s https://api.github.com/repos/digitalocean/doctl/releases/latest \
                | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -sL "https://github.com/digitalocean/doctl/releases/download/v${VER}/doctl-${VER}-linux-amd64.tar.gz" \
            | tar -xz
          sudo mv doctl /usr/local/bin
      - name: ğŸ”‘ Authenticate doctl
        run: doctl auth init -t "$DIGITALOCEAN_TOKEN"

      # â”€â”€ Terraform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ› ï¸  Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.2
          cli_config_credentials_hostname: app.terraform.io

      - name: ğŸš€ terraform init
        run: terraform -chdir=infra init -upgrade

      - name: ğŸ”„ Import any existing DO resources
        run: bash infra/import_existing.sh

      - name: ğŸ“ terraform plan
        run: terraform -chdir=infra plan -input=false

      - name: âœ… terraform apply
        run: terraform -chdir=infra apply -auto-approve -input=false

      # â”€â”€ Capture droplet IPs (map âœ separate vars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - id: ip
        name: ğŸŒ Extract droplet IPs
        shell: bash
        run: |
          JSON=$(terraform -chdir=infra output -json droplet_ips)
          echo "root=$(echo  "$JSON" | jq -r '.root')"  >> "$GITHUB_OUTPUT"
          echo "ui=$(echo    "$JSON" | jq -r '.ui')"    >> "$GITHUB_OUTPUT"
          echo "api=$(echo   "$JSON" | jq -r '.api')"   >> "$GITHUB_OUTPUT"
          echo "admin=$(echo "$JSON" | jq -r '.admin')" >> "$GITHUB_OUTPUT"

      # â”€â”€ Update DNS A records in NameSilo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ› ï¸  Update NameSilo DNS
        env:
          ROOT_IP:  ${{ steps.ip.outputs.root }}
          UI_IP:    ${{ steps.ip.outputs.ui }}
          API_IP:   ${{ steps.ip.outputs.api }}
          ADMIN_IP: ${{ steps.ip.outputs.admin }}
        run: bash infra/update_namesilo.sh

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3)  Deploy marketing site if its source changed
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-marketing:
    needs: [ filter, terraform ]
    if: needs.filter.outputs.site_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸  Check out repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install rsync & SSH
        run: sudo apt-get update -y && sudo apt-get install -y rsync openssh-client

      - name: ğŸ”‘ Load SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸšš Sync axialy-marketing-site â†’ droplet
        env:
          HOST_IP: ${{ needs.terraform.outputs.root_ip }}
        run: |
          rsync -avz --delete axialy-marketing-site/ root@$HOST_IP:/var/www/html/
