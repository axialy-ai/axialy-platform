name: Terraform DigitalOcean

on:
  push:
    branches: ["main"]

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      TF_VAR_do_token:    ${{ secrets.DIGITALOCEAN_TOKEN }}
      NAMESILO_API_KEY:   ${{ secrets.NAMESILO_API_KEY }}
      NAMESILO_DOMAIN:    axialy.ai
      DROPLET_SSH_KEY:    ${{ secrets.DROPLET_SSH_KEY }}

    steps:
    # 1 â€“ checkout
    - uses: actions/checkout@v4

    # 2 â€“ start clean
    - name: Remove stale Terraform artefacts
      run: |
        rm -f infra/terraform.tfstate*
        rm -f infra/.terraform.lock.hcl
        rm -rf infra/.terraform

    # 3 â€“ doctl
    - name: Install doctl & authenticate
      run: |
        set -e
        VER=$(curl -s https://api.github.com/repos/digitalocean/doctl/releases/latest \
               | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -sL "https://github.com/digitalocean/doctl/releases/download/v${VER}/doctl-${VER}-linux-amd64.tar.gz" \
          | tar -xz
        sudo mv doctl /usr/local/bin
        doctl auth init -t "$DIGITALOCEAN_TOKEN"

    # 4 â€“ Terraform CLI
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.8.2

    - name: Terraform init
      run: terraform -chdir=infra init -upgrade

    # 5 â€“ import anything that already exists
    - name: Import existing resources
      run: bash infra/import_existing.sh

    # 6 â€“ DNS: purge A-records pointing to deleted droplets
    - name: Purge stale NameSilo A-records
      env:
        NAMESILO_API_KEY: ${{ env.NAMESILO_API_KEY }}
        NAMESILO_DOMAIN:  ${{ env.NAMESILO_DOMAIN }}
      run: bash infra/purge_namesilo_missing.sh

    # 7 â€“ plan & apply
    - name: Terraform plan
      run: terraform -chdir=infra plan -input=false

    - name: Terraform apply
      if: github.ref == 'refs/heads/main'
      run: terraform -chdir=infra apply -auto-approve -input=false

    # 8 â€“ grab the public IPs
    - id: ips
      run: |
        IPS=$(terraform -chdir=infra output -json droplet_ips)
        echo "ROOT_IP=$(  echo "$IPS" | jq -r '.root')"  >> "$GITHUB_ENV"
        echo "UI_IP=$(    echo "$IPS" | jq -r '.ui')"    >> "$GITHUB_ENV"
        echo "API_IP=$(   echo "$IPS" | jq -r '.api')"   >> "$GITHUB_ENV"
        echo "ADMIN_IP=$( echo "$IPS" | jq -r '.admin')" >> "$GITHUB_ENV"

    # 9 â€“ (ðŸ’¡ any new IPs)              â†’ DNS
    - name: Update NameSilo DNS
      env:
        NAMESILO_API_KEY: ${{ env.NAMESILO_API_KEY }}
        NAMESILO_DOMAIN:  ${{ env.NAMESILO_DOMAIN }}
      run: bash infra/update_namesilo.sh

    # 10 â€“ upload each site (re-runs every time â€“ idempotent)
    - name: Deploy marketing site â†’ root
      uses: appleboy/scp-action@v0.1.5
      with:
        host:     ${{ env.ROOT_IP }}
        username: root
        key:      ${{ env.DROPLET_SSH_KEY }}
        source:   "axialy-marketing-site/*"
        target:   "/var/www/html/"
        strip_components: 1
        timeout: 120s
        retry:   5

    - name: Deploy UI product â†’ ui droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:     ${{ env.UI_IP }}
        username: root
        key:      ${{ env.DROPLET_SSH_KEY }}
        source:   "axialy-ui-product/*"
        target:   "/var/www/html/"
        strip_components: 1
        timeout: 120s
        retry:   5

    - name: Deploy Admin product â†’ admin droplet
      uses: appleboy/scp-action@v0.1.5
      with:
        host:     ${{ env.ADMIN_IP }}
        username: root
        key:      ${{ env.DROPLET_SSH_KEY }}
        source:   "axialy-admin-product/*"
        target:   "/var/www/html/"
        strip_components: 1
        timeout: 120s
        retry:   5
